<div class="block py-6" style="width:1200px; margin:0 auto; text-align: justify;">
  <form class="box" action="#">
    <div class="column is-full">
      <button class="button is-primary is-fullwidth" id="startMusic">Train music evaluator</button>
    </div>
  </form>

  <form class="box" action="#">
    <div class="column is-full">
      <button class="button is-primary is-fullwidth" id="startImages">Train image evaluator</button>
    </div>
  </form>

  <div class="box">
    <p class="mb-3" id="fine_tuning_status">Training status</p>
    <progress id="fine_tuning_progress" class="progress" value="0" max="100">0%</progress>
    <canvas id="chart_loss"></canvas>
    <p class="mb-3">This graph shows (100% - <a href="https://en.wikipedia.org/wiki/Mean_absolute_percentage_error">MAPE</a>) metric of how well the model predicts your preferences. Baseline line shows metric of mean value of all training scores calculated relative to test scores. If the 'Test accuracy' not much greater then a baseline, it means there is not enough user rated datapoints yet or user rating values are too similar to each other.</p>
  </div>

  
  <script src="static/js/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/1.0.2/chartjs-plugin-annotation.min.js"></script>
  
  <script type="text/javascript">
    const CHART_COLORS = {
      red: 'rgb(255, 99, 132)',
      orange: 'rgb(255, 159, 64)',
      yellow: 'rgb(255, 205, 86)',
      green: 'rgb(75, 192, 192)',
      blue: 'rgb(54, 162, 235)',
      purple: 'rgb(153, 102, 255)',
      grey: 'rgb(201, 203, 207)',
      cayan: 'rgb(75, 192, 192)',
    };

    let chart_loss = (()=>{
      const ctx = document.getElementById('chart_loss');

      const labels = [1, 2, 3, 4, 5, 6, 7];
      const data = {
        //labels: labels,
        datasets: [{
          label: 'Train accuracy',
          data: [65, 59, 80, 81, 56, 55, 40],
          fill: false,
          borderColor: CHART_COLORS.red,
          //tension: 0.1
          yAxisID: 'y',
          indexAxis: 'x' // Set indexAxis here
        },
        {
          label: 'Test accuracy',
          data: [65, 59, 80, 81, 56, 55, 40],
          fill: false,
          borderColor: CHART_COLORS.blue,
          //tension: 0.1
          yAxisID: 'y',
          indexAxis: 'x' // Set indexAxis here
        }]
      };
    
      const config = {
        type: 'line',
        data: data,
        options: {
          responsive: true,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          stacked: false,
          animation: false, // disable animations
          plugins: {
            title: {
              display: true,
              text: 'Train and Test Accuracy'
            },
            annotation: {
              annotations: [{
                type: 'line',
                mode: 'horizontal',
                scaleID: 'y',
                value: 10,
                borderColor: CHART_COLORS.cayan,
                borderWidth: 4,
                borderDash: [5, 5], 
                label: {
                  enabled: true,
                  content: 'Baseline'
                }
              }]
            },
            decimation: {
              enabled: true,
              algorithm: 'lttb', // Choose your decimation algorithm
              samples: 20, // Number of data points to keep
              threshold: 20 // Minimum data points to consider decimation
            }
          },
          scales: {
            y: {
              type: 'linear',
              display: true,
              position: 'left',
            }
          }
        }
      };

      return new Chart(ctx, config);
    })();

    function update_chart(data) {
      train_accuracy_hist = data['train_accuracy_hist']
      test_accuracy_hist = data['test_accuracy_hist']
      percent = data['percent']
      status = data['status']
      baseline_accuracy = data['baseline_accuracy']

      chart_loss.data.labels = Array.from(train_accuracy_hist.keys());
      chart_loss.data.datasets[0].data = train_accuracy_hist
      chart_loss.data.datasets[1].data = test_accuracy_hist
      chart_loss.options.plugins.annotation.annotations[0].value = baseline_accuracy
      chart_loss.update();

      $("#fine_tuning_progress").val(percent)
      $("#fine_tuning_status").text(status)
    }

    
    //update_chart(''[1,2,3,4,5], [5,5,4,4,3]) 

    $("document").ready(function(){
      socket.on('connect', function(data){
        //socket.send("User connected!")
      })

      socket.on('emit_train_page_display_train_data', function(data){
        update_chart(data)
      })
      
      $('#startMusic').on('click', function(){
        socket.emit("emit_train_page_start_audio_evaluator_training")
      })

      $('#startImages').on('click', function(){
        socket.emit("emit_train_page_start_image_evaluator_training")
      })
    });
  </script>    
</div>